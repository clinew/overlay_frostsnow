From 71c3ec2182251ddb87e7f6177d9584a9f5b13c69 Mon Sep 17 00:00:00 2001
From: Wade Cline <wadecline@hotmail.com>
Date: Sun, 30 Apr 2023 23:29:34 -0700
Subject: [PATCH 8/8] Fix cert expiration for dates after year 2049

---
 src/modules/extra/m_ssl_openssl.cpp | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/src/modules/extra/m_ssl_openssl.cpp b/src/modules/extra/m_ssl_openssl.cpp
index 5c1c6c272..eba890b94 100644
--- a/src/modules/extra/m_ssl_openssl.cpp
+++ b/src/modules/extra/m_ssl_openssl.cpp
@@ -42,6 +42,7 @@
 
 #include "inspircd.h"
 #include "iohook.h"
+#include "modules/ircv3_servertime.h"
 #include "modules/ssl.h"
 
 #ifdef __GNUC__
@@ -817,13 +818,13 @@ class OpenSSLIOHook : public SSLIOHook
 		certinfo->activation = GetTime(X509_getm_notBefore(cert));
 		certinfo->expiration = GetTime(X509_getm_notAfter(cert));
 
-		int activated = ASN1_UTCTIME_cmp_time_t(X509_getm_notBefore(cert), ServerInstance->Time());
+		int activated = ASN1_TIME_cmp_time_t(X509_getm_notBefore(cert), ServerInstance->Time());
 		if (activated != -1 && activated != 0)
-			certinfo->error = "Certificate not activated";
+			certinfo->error = "Certificate not activated (notBefore '" + IRCv3::ServerTime::FormatTime(certinfo->activation) + "')";
 
-		int expired = ASN1_UTCTIME_cmp_time_t(X509_getm_notAfter(cert), ServerInstance->Time());
+		int expired = ASN1_TIME_cmp_time_t(X509_getm_notAfter(cert), ServerInstance->Time());
 		if (expired != 0 && expired != 1)
-			certinfo->error = "Certificate has expired";
+			certinfo->error = "Certificate has expired (notAfter '" + IRCv3::ServerTime::FormatTime(certinfo->expiration) + "')";
 
 		VerifyCertificateStrength(cert, certinfo->error);
 	}
-- 
2.39.3

